#!/usr/bin/env ruby

def git_clone(url, path)
  %x[ git -C #{path} pull || git clone #{url} #{path} ]
end

# Homebrew
%x[ ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" ]

# Directories
%x[ mkdir -p /Users/olivierlacan/Development/oss ]
%x[ mkdir -p /Users/olivierlacan/Development/perso ]

# Repos
git_clone(*%W[ https://github.com/olivierlacan/olivierlacan.com.git /Users/olivierlacan/Development/perso/olivierlacan.com/ ])
git_clone(*%W[ https://github.com/olivierlacan/rubygems.org.git /Users/olivierlacan/Development/oss/rubygems.org/ ])
git_clone(*%W[ https://github.com/badges/shields.git /Users/olivierlacan/Development/oss/shields/ ])

# Dotfiles
git_clone(*%W[ https://github.com/olivierlacan/dotfiles.git /Users/olivierlacan/.dotfiles ])

# Symlink .bash_profile
%x[ ln -s /Users/olivierlacan/.dotfiles/bash/.bash_profile /Users/olivierlacan/.bash_profile ]
%x[ ln -s /Users/olivierlacan/.dotfiles/bash/.bash_aliases /Users/olivierlacan/.bash_aliases ]


# Symlink Brewfile
%x[ ln -s /Users/olivierlacan/.dotfiles/Brewfile /Users/olivierlacan/Brewfile ]

# Brewfile
%x[ cd ]
%x[ brew tap homebrew/bundle ]
%x[ brew bundle ]

# PostgreSQL
%x[ ln -sfv /usr/local/opt/postgresql/*.plist /Users/olivierlacan/Library/LaunchAgents ]
%x[ launchctl load /Users/olivierlacan/Library/LaunchAgents/homebrew.mxcl.postgresql.plist ]

# rbenv
git_clone(*%W[ https://github.com/rbenv/rbenv.git /Users/olivierlacan/.rbenv ])
git_clone(*%W[ https://github.com/rbenv/ruby-build.git /Users/olivierlacan/.rbenv/plugins/ruby-build ])
git_clone(*%W[ https://github.com/rbenv/rbenv-default-gems.git /Users/olivierlacan/.rbenv/plugins/rbenv-default-gems])
%x[ echo bundler > /Users/olivierlacan/.rbenv/default-gems ]

# Reload Profile
%x[ source /Users/olivierlacan/.bash_profile ]

%x[ rbenv install --skip-existing 2.2.3 ]
%x[ rbenv global 2.2.3 ]

# basic git config
%x[ git config --global user.name 'Olivier Lacan' ]
%x[ git config --global user.email hi@olivierlacan.com ]
%x[ git config --global push.default simple ]

# setup git to use osxkeychain as the credential helper so 
# that it remembers GitHub credentials
%x[ git config --global credential.helper osxkeychain ]

puts("Press Enter to continue...") 
if %x[ git credential-osxkeychain get github.com ]
  puts "git is now authorized to look stuff up from Keychain!"
else
  puts "something went to shit!"
end

%x[ ln -sf "/Applications/Sublime Text.app/Contents/SharedSupport/bin/subl" /usr/local/bin/sublime ]

# RubyGems
%x[ gem update --system ]
%x[ echo 'gem: --no-document' >> /Users/olivierlacan/.gemrc ]

# Bundler
cores = (%x[ sysctl -n hw.ncpu ].to_i) - 1
%x[ bundle config --global jobs #{cores} ]

private 

def s(arguments)
  system(arguments)
end